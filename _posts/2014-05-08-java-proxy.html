---
layout: default
title: java动态代理
categories:
  - java
---
<style>
.dp-highlighter ol {
    background-color: #D0D0D0;
    border: 1px solid #D1D7DC;
    color: #2B91AF;
    list-style: decimal outside none;
    margin: 0 0 1px;
    padding: 2px 0;
}
</style>
<h2>{{ page.title }}</h2>
<div id="sina_keyword_ad_area2" class="articalContent  ">
		<strong> Java中动态代理的实现</strong><br>
<div class="blog_content" id="blog_content">
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 以下的内容部分参考了网络上的内容，在此对原作者表示感谢！
<br>
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Java中动态代理的实现，关键就是这两个东西：Proxy、InvocationHandler，下面从InvocationHandler接口中的invoke方法入手，简单说明一下Java如何实现动态代理的。
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 首先，invoke方法的完整形式如下：
<br><div class="dp-highlighter" id=""><div class="bar"><div class="tools">Java代码 public Object invoke(Object proxy, Method method, Object[] args) throws Throwable
    {

        method.invoke(obj, args);

        return null;
	}</pre>
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 首先猜测一下，method是调用的方法，即需要执行的方法；args是方法的参数；proxy，这个参数是什么？以上invoke()方法的实现即是比较标准的形式，我们看到，这里并没有用到proxy参数。查看JDK文档中Proxy的说明，如下：
<br><div class="dp-highlighter" id=""><div class="bar"><div class="tools">Java代码 <embed width="14" height="15" pluginspage="http://www.macromedia.com/go/getflashplayer" type="application/x-shockwave-flash" allowscriptaccess="always" quality="high" flashvars="clipboard=A%20method%20invocation%20on%20a%20proxy%20instance%20through%20one%20of%20its%20proxy%20interfaces%20will%20be%20dispatched%20to%20the%20invoke%20method%20of%20the%20instance's%20invocation%20handler%2C%20passing%20the%20proxy%20instance%2Ca%20java.lang.reflect.Method%20object%20identifying%20the%20method%20that%20was%20invoked%2C%20and%20an%20array%20of%20type%20Object%20containing%20the%20arguments." src="/javascripts/syntaxhighlighter/clipboard_new.swf" wmode="transparent">&nbsp;<a onclick="code_favorites_do_favorite(this);return false;" title="收藏这段代码" href="javascript:void()"><img alt="收藏代码" src="/images/icon_star.png" class="star"><img style="display:none" src="/images/spinner.gif" class="spinner"></a></div></div><ol start="1" class="dp-j"><li><span><span>A&nbsp;method&nbsp;invocation&nbsp;on&nbsp;a&nbsp;proxy&nbsp;instance&nbsp;through&nbsp;one&nbsp;of&nbsp;its&nbsp;proxy&nbsp;interfaces&nbsp;will&nbsp;be&nbsp;dispatched&nbsp;to&nbsp;the&nbsp;invoke&nbsp;method&nbsp;of&nbsp;the&nbsp;instance's&nbsp;invocation&nbsp;handler,&nbsp;passing&nbsp;the&nbsp;proxy&nbsp;instance,a&nbsp;java.lang.reflect.Method&nbsp;object&nbsp;identifying&nbsp;the&nbsp;method&nbsp;that&nbsp;was&nbsp;invoked,&nbsp;and&nbsp;an&nbsp;array&nbsp;of&nbsp;type&nbsp;Object&nbsp;containing&nbsp;the&nbsp;arguments.&nbsp;&nbsp;</span></span></li></ol></div><pre name="code" class="java" style="display: none;" codeable_id="841798" codeable_type="Blog" source_url="http://paddy-w.iteye.com/blog/841798" pre_index="1" title="InvocationHandler中invoke()方法的调用问题">A method invocation on a proxy instance through one of its proxy interfaces will be dispatched to the invoke method of the instance's invocation handler, passing the proxy instance,a java.lang.reflect.Method object identifying the method that was invoked, and an array of type Object containing the arguments.</pre>
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 由此可以知道以上的猜测是正确的，同时也知道，proxy参数传递的即是代理类的实例。
<br>
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 为了方便说明，这里写一个简单的例子来实现动态代理。
<br>
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <div class="dp-highlighter" id=""><div class="bar"><div class="tools">Java代码 <embed width="14" height="15" pluginspage="http://www.macromedia.com/go/getflashplayer" type="application/x-shockwave-flash" allowscriptaccess="always" quality="high" flashvars="clipboard=%2F%2F%E6%8A%BD%E8%B1%A1%E8%A7%92%E8%89%B2%EF%BC%88%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E5%8F%AA%E8%83%BD%E4%BB%A3%E7%90%86%E6%8E%A5%E5%8F%A3%EF%BC%89%0Apublic%20interface%20Subject%20%7B%0A%09%0A%09public%20void%20request()%3B%0A%7D" src="/javascripts/syntaxhighlighter/clipboard_new.swf" wmode="transparent">&nbsp;<a onclick="code_favorites_do_favorite(this);return false;" title="收藏这段代码" href="javascript:void()"><img alt="收藏代码" src="/images/icon_star.png" class="star"><img style="display:none" src="/images/spinner.gif" class="spinner"></a></div></div><ol start="1" class="dp-j"><li><span><span class="comment">//抽象角色（动态代理只能代理接口）</span><span>&nbsp;&nbsp;</span></span></li><li><span><span class="keyword">public</span><span>&nbsp;</span><span class="keyword">interface</span><span>&nbsp;Subject&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">public</span><span>&nbsp;</span><span class="keyword">void</span><span>&nbsp;request();&nbsp;&nbsp;</span></span></li><li><span>}&nbsp;&nbsp;</span></li></ol></div><pre name="code" class="java" style="display: none;" codeable_id="841798" codeable_type="Blog" source_url="http://paddy-w.iteye.com/blog/841798" pre_index="2" title="InvocationHandler中invoke()方法的调用问题">//抽象角色（动态代理只能代理接口）
public interface Subject {
	
	public void request();
}</pre>
<br><div class="dp-highlighter" id=""><div class="bar"><div class="tools">Java代码 <embed width="14" height="15" pluginspage="http://www.macromedia.com/go/getflashplayer" type="application/x-shockwave-flash" allowscriptaccess="always" quality="high" flashvars="clipboard=%2F%2F%E7%9C%9F%E5%AE%9E%E8%A7%92%E8%89%B2%EF%BC%9A%E5%AE%9E%E7%8E%B0%E4%BA%86Subject%E7%9A%84request()%E6%96%B9%E6%B3%95%0Apublic%20class%20RealSubject%20implements%20Subject%7B%0A%09%0A%09public%20void%20request()%7B%0A%09%09System.out.println(%22From%20real%20subject.%22)%3B%0A%09%7D%0A%7D" src="/javascripts/syntaxhighlighter/clipboard_new.swf" wmode="transparent">&nbsp;<a onclick="code_favorites_do_favorite(this);return false;" title="收藏这段代码" href="javascript:void()"><img alt="收藏代码" src="/images/icon_star.png" class="star"><img style="display:none" src="/images/spinner.gif" class="spinner"></a></div></div><ol start="1" class="dp-j"><li><span><span class="comment">//真实角色：实现了Subject的request()方法</span><span>&nbsp;&nbsp;</span></span></li><li><span><span class="keyword">public</span><span>&nbsp;</span><span class="keyword">class</span><span>&nbsp;RealSubject&nbsp;</span><span class="keyword">implements</span><span>&nbsp;Subject{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">public</span><span>&nbsp;</span><span class="keyword">void</span><span>&nbsp;request(){&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(<span class="string">"From&nbsp;real&nbsp;subject."</span><span>);&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>}&nbsp;&nbsp;</span></li></ol></div><pre name="code" class="java" style="display: none;" codeable_id="841798" codeable_type="Blog" source_url="http://paddy-w.iteye.com/blog/841798" pre_index="3" title="InvocationHandler中invoke()方法的调用问题">//真实角色：实现了Subject的request()方法
public class RealSubject implements Subject{
	
	public void request(){
		System.out.println("From real subject.");
	}
}</pre>
<br><div class="dp-highlighter" id=""><div class="bar"><div class="tools">Java代码 <embed width="14" height="15" pluginspage="http://www.macromedia.com/go/getflashplayer" type="application/x-shockwave-flash" allowscriptaccess="always" quality="high" flashvars="clipboard=%2F%2F%E5%AE%9E%E7%8E%B0%E4%BA%86InvocationHandler%0Apublic%20class%20DynamicSubject%20implements%20InvocationHandler%0A%7B%0A%20%20%20%20private%20Object%20obj%3B%2F%2F%E8%BF%99%E6%98%AF%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E7%9A%84%E5%A5%BD%E5%A4%84%EF%BC%8C%E8%A2%AB%E5%B0%81%E8%A3%85%E7%9A%84%E5%AF%B9%E8%B1%A1%E6%98%AFObject%E7%B1%BB%E5%9E%8B%EF%BC%8C%E6%8E%A5%E5%8F%97%E4%BB%BB%E6%84%8F%E7%B1%BB%E5%9E%8B%E7%9A%84%E5%AF%B9%E8%B1%A1%0A%0A%20%20%20%20public%20DynamicSubject()%0A%20%20%20%20%7B%0A%20%20%20%20%7D%0A%0A%20%20%20%20public%20DynamicSubject(Object%20obj)%0A%20%20%20%20%7B%0A%20%20%20%20%20%20%20%20this.obj%20%3D%20obj%3B%0A%20%20%20%20%7D%0A%0A%20%20%20%20%2F%2F%E8%BF%99%E4%B8%AA%E6%96%B9%E6%B3%95%E4%B8%8D%E6%98%AF%E6%88%91%E4%BB%AC%E6%98%BE%E7%A4%BA%E7%9A%84%E5%8E%BB%E8%B0%83%E7%94%A8%0A%20%20%20%20public%20Object%20invoke(Object%20proxy%2C%20Method%20method%2C%20Object%5B%5D%20args)%20throws%20Throwable%0A%20%20%20%20%7B%0A%20%20%20%20%20%20%20%20System.out.println(%22before%20calling%20%22%20%2B%20method)%3B%0A%0A%20%20%20%20%20%20%20%20method.invoke(obj%2C%20args)%3B%0A%0A%20%20%20%20%20%20%20%20System.out.println(%22after%20calling%20%22%20%2B%20method)%3B%0A%0A%20%20%20%20%20%20%20%20return%20null%3B%0A%09%7D%0A%0A%7D" src="/javascripts/syntaxhighlighter/clipboard_new.swf" wmode="transparent">&nbsp;<a onclick="code_favorites_do_favorite(this);return false;" title="收藏这段代码" href="javascript:void()"><img alt="收藏代码" src="/images/icon_star.png" class="star"><img style="display:none" src="/images/spinner.gif" class="spinner"></a></div></div><ol start="1" class="dp-j"><li><span><span class="comment">//实现了InvocationHandler</span><span>&nbsp;&nbsp;</span></span></li><li><span><span class="keyword">public</span><span>&nbsp;</span><span class="keyword">class</span><span>&nbsp;DynamicSubject&nbsp;</span><span class="keyword">implements</span><span>&nbsp;InvocationHandler&nbsp;&nbsp;</span></span></li><li><span>{&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">private</span><span>&nbsp;Object&nbsp;obj;</span><span class="comment">//这是动态代理的好处，被封装的对象是Object类型，接受任意类型的对象</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">public</span><span>&nbsp;DynamicSubject()&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">public</span><span>&nbsp;DynamicSubject(Object&nbsp;obj)&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">this</span><span>.obj&nbsp;=&nbsp;obj;&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//这个方法不是我们显示的去调用</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">public</span><span>&nbsp;Object&nbsp;invoke(Object&nbsp;proxy,&nbsp;Method&nbsp;method,&nbsp;Object[]&nbsp;args)&nbsp;</span><span class="keyword">throws</span><span>&nbsp;Throwable&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(<span class="string">"before&nbsp;calling&nbsp;"</span><span>&nbsp;+&nbsp;method);&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;method.invoke(obj,&nbsp;args);&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(<span class="string">"after&nbsp;calling&nbsp;"</span><span>&nbsp;+&nbsp;method);&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span><span>&nbsp;</span><span class="keyword">null</span><span>;&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;</span></li><li><span>}&nbsp;&nbsp;</span></li></ol></div><pre name="code" class="java" style="display: none;" codeable_id="841798" codeable_type="Blog" source_url="http://paddy-w.iteye.com/blog/841798" pre_index="4" title="InvocationHandler中invoke()方法的调用问题">//实现了InvocationHandler
public class DynamicSubject implements InvocationHandler
{
    private Object obj;//这是动态代理的好处，被封装的对象是Object类型，接受任意类型的对象

    public DynamicSubject()
    {
    }

    public DynamicSubject(Object obj)
    {
        this.obj = obj;
    }

    //这个方法不是我们显示的去调用
    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable
    {
        System.out.println("before calling " + method);

        method.invoke(obj, args);

        System.out.println("after calling " + method);

        return null;
	}

}</pre>
<br><div class="dp-highlighter" id=""><div class="bar"><div class="tools">Java代码 <embed width="14" height="15" pluginspage="http://www.macromedia.com/go/getflashplayer" type="application/x-shockwave-flash" allowscriptaccess="always" quality="high" flashvars="clipboard=%2F%2F%E5%AE%A2%E6%88%B7%E7%AB%AF%EF%BC%9A%E7%94%9F%E6%88%90%E4%BB%A3%E7%90%86%E5%AE%9E%E4%BE%8B%EF%BC%8C%E5%B9%B6%E8%B0%83%E7%94%A8%E4%BA%86request()%E6%96%B9%E6%B3%95%0Apublic%20class%20Client%20%7B%0A%0A%09public%20static%20void%20main(String%5B%5D%20args)%20throws%20Throwable%7B%0A%09%09%2F%2F%20TODO%20Auto-generated%20method%20stub%0A%0A%09%09Subject%20rs%3Dnew%20RealSubject()%3B%2F%2F%E8%BF%99%E9%87%8C%E6%8C%87%E5%AE%9A%E8%A2%AB%E4%BB%A3%E7%90%86%E7%B1%BB%0A%09%09InvocationHandler%20ds%3Dnew%20DynamicSubject(rs)%3B%0A%09%09Class%3C%3F%3E%20cls%3Drs.getClass()%3B%0A%09%09%0A%09%09%2F%2F%E4%BB%A5%E4%B8%8B%E6%98%AF%E4%B8%80%E6%AC%A1%E6%80%A7%E7%94%9F%E6%88%90%E4%BB%A3%E7%90%86%0A%09%09%0A%09%09Subject%20subject%3D(Subject)%20Proxy.newProxyInstance(%0A%09%09%09%09cls.getClassLoader()%2Ccls.getInterfaces()%2C%20ds)%3B%0A%09%09%0A%09%09%2F%2F%E8%BF%99%E9%87%8C%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%E8%BF%90%E8%A1%8C%E7%BB%93%E6%9E%9C%E8%AF%81%E6%98%8Esubject%E6%98%AFProxy%E7%9A%84%E4%B8%80%E4%B8%AA%E5%AE%9E%E4%BE%8B%EF%BC%8C%E8%BF%99%E4%B8%AA%E5%AE%9E%E4%BE%8B%E5%AE%9E%E7%8E%B0%E4%BA%86Subject%E6%8E%A5%E5%8F%A3%0A%09%09System.out.println(subject%20instanceof%20Proxy)%3B%0A%09%09%0A%09%09%2F%2F%E8%BF%99%E9%87%8C%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%87%BAsubject%E7%9A%84Class%E7%B1%BB%E6%98%AF%24Proxy0%2C%E8%BF%99%E4%B8%AA%24Proxy0%E7%B1%BB%E7%BB%A7%E6%89%BF%E4%BA%86Proxy%EF%BC%8C%E5%AE%9E%E7%8E%B0%E4%BA%86Subject%E6%8E%A5%E5%8F%A3%0A%09%09System.out.println(%22subject%E7%9A%84Class%E7%B1%BB%E6%98%AF%EF%BC%9A%22%2Bsubject.getClass().toString())%3B%0A%09%09%0A%09%09System.out.print(%22subject%E4%B8%AD%E7%9A%84%E5%B1%9E%E6%80%A7%E6%9C%89%EF%BC%9A%22)%3B%0A%09%09%0A%09%09Field%5B%5D%20field%3Dsubject.getClass().getDeclaredFields()%3B%0A%09%09for(Field%20f%3Afield)%7B%0A%09%09%09System.out.print(f.getName()%2B%22%2C%20%22)%3B%0A%09%09%7D%0A%09%09%0A%09%09System.out.print(%22%5Cn%22%2B%22subject%E4%B8%AD%E7%9A%84%E6%96%B9%E6%B3%95%E6%9C%89%EF%BC%9A%22)%3B%0A%09%09%0A%09%09Method%5B%5D%20method%3Dsubject.getClass().getDeclaredMethods()%3B%0A%09%09%0A%09%09for(Method%20m%3Amethod)%7B%0A%09%09%09System.out.print(m.getName()%2B%22%2C%20%22)%3B%0A%09%09%7D%0A%09%09%0A%09%09System.out.println(%22%5Cn%22%2B%22subject%E7%9A%84%E7%88%B6%E7%B1%BB%E6%98%AF%EF%BC%9A%22%2Bsubject.getClass().getSuperclass())%3B%0A%09%09%0A%09%09System.out.print(%22%5Cn%22%2B%22subject%E5%AE%9E%E7%8E%B0%E7%9A%84%E6%8E%A5%E5%8F%A3%E6%98%AF%EF%BC%9A%22)%3B%0A%09%09%0A%09%09Class%3C%3F%3E%5B%5D%20interfaces%3Dsubject.getClass().getInterfaces()%3B%0A%09%09%0A%09%09for(Class%3C%3F%3E%20i%3Ainterfaces)%7B%0A%09%09%09System.out.print(i.getName()%2B%22%2C%20%22)%3B%0A%09%09%7D%0A%0A%09%09System.out.println(%22%5Cn%5Cn%22%2B%22%E8%BF%90%E8%A1%8C%E7%BB%93%E6%9E%9C%E4%B8%BA%EF%BC%9A%22)%3B%0A%09%09subject.request()%3B%0A%09%7D%0A%7D" src="/javascripts/syntaxhighlighter/clipboard_new.swf" wmode="transparent">&nbsp;<a onclick="code_favorites_do_favorite(this);return false;" title="收藏这段代码" href="javascript:void()"><img alt="收藏代码" src="/images/icon_star.png" class="star"><img style="display:none" src="/images/spinner.gif" class="spinner"></a></div></div><ol start="1" class="dp-j"><li><span><span class="comment">//客户端：生成代理实例，并调用了request()方法</span><span>&nbsp;&nbsp;</span></span></li><li><span><span class="keyword">public</span><span>&nbsp;</span><span class="keyword">class</span><span>&nbsp;Client&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">public</span><span>&nbsp;</span><span class="keyword">static</span><span>&nbsp;</span><span class="keyword">void</span><span>&nbsp;main(String[]&nbsp;args)&nbsp;</span><span class="keyword">throws</span><span>&nbsp;Throwable{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;TODO&nbsp;Auto-generated&nbsp;method&nbsp;stub</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;rs=<span class="keyword">new</span><span>&nbsp;RealSubject();</span><span class="comment">//这里指定被代理类</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;InvocationHandler&nbsp;ds=<span class="keyword">new</span><span>&nbsp;DynamicSubject(rs);&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Class&lt;?&gt;&nbsp;cls=rs.getClass();&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//以下是一次性生成代理</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;subject=(Subject)&nbsp;Proxy.newProxyInstance(&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cls.getClassLoader(),cls.getInterfaces(),&nbsp;ds);&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//这里可以通过运行结果证明subject是Proxy的一个实例，这个实例实现了Subject接口</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(subject&nbsp;<span class="keyword">instanceof</span><span>&nbsp;Proxy);&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//这里可以看出subject的Class类是$Proxy0,这个$Proxy0类继承了Proxy，实现了Subject接口</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(<span class="string">"subject的Class类是："</span><span>+subject.getClass().toString());&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.print(<span class="string">"subject中的属性有："</span><span>);&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Field[]&nbsp;field=subject.getClass().getDeclaredFields();&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span><span>(Field&nbsp;f:field){&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.print(f.getName()+<span class="string">",&nbsp;"</span><span>);&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.print(<span class="string">"\n"</span><span>+</span><span class="string">"subject中的方法有："</span><span>);&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Method[]&nbsp;method=subject.getClass().getDeclaredMethods();&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span><span>(Method&nbsp;m:method){&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.print(m.getName()+<span class="string">",&nbsp;"</span><span>);&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(<span class="string">"\n"</span><span>+</span><span class="string">"subject的父类是："</span><span>+subject.getClass().getSuperclass());&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.print(<span class="string">"\n"</span><span>+</span><span class="string">"subject实现的接口是："</span><span>);&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Class&lt;?&gt;[]&nbsp;interfaces=subject.getClass().getInterfaces();&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span><span>(Class&lt;?&gt;&nbsp;i:interfaces){&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.print(i.getName()+<span class="string">",&nbsp;"</span><span>);&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(<span class="string">"\n\n"</span><span>+</span><span class="string">"运行结果为："</span><span>);&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;subject.request();&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>}&nbsp;&nbsp;</span></li></ol></div><pre name="code" class="java" style="display: none;" codeable_id="841798" codeable_type="Blog" source_url="http://paddy-w.iteye.com/blog/841798" pre_index="5" title="InvocationHandler中invoke()方法的调用问题">//客户端：生成代理实例，并调用了request()方法
public class Client {

	public static void main(String[] args) throws Throwable{
		// TODO Auto-generated method stub

		Subject rs=new RealSubject();//这里指定被代理类
		InvocationHandler ds=new DynamicSubject(rs);
		Class&lt;?&gt; cls=rs.getClass();
		
		//以下是一次性生成代理
		
		Subject subject=(Subject) Proxy.newProxyInstance(
				cls.getClassLoader(),cls.getInterfaces(), ds);
		
		//这里可以通过运行结果证明subject是Proxy的一个实例，这个实例实现了Subject接口
		System.out.println(subject instanceof Proxy);
		
		//这里可以看出subject的Class类是$Proxy0,这个$Proxy0类继承了Proxy，实现了Subject接口
		System.out.println("subject的Class类是："+subject.getClass().toString());
		
		System.out.print("subject中的属性有：");
		
		Field[] field=subject.getClass().getDeclaredFields();
		for(Field f:field){
			System.out.print(f.getName()+", ");
		}
		
		System.out.print("\n"+"subject中的方法有：");
		
		Method[] method=subject.getClass().getDeclaredMethods();
		
		for(Method m:method){
			System.out.print(m.getName()+", ");
		}
		
		System.out.println("\n"+"subject的父类是："+subject.getClass().getSuperclass());
		
		System.out.print("\n"+"subject实现的接口是：");
		
		Class&lt;?&gt;[] interfaces=subject.getClass().getInterfaces();
		
		for(Class&lt;?&gt; i:interfaces){
			System.out.print(i.getName()+", ");
		}

		System.out.println("\n\n"+"运行结果为：");
		subject.request();
	}
}</pre>
<br><div class="dp-highlighter" id=""><div class="bar"><div class="tools">Xml代码 <embed width="14" height="15" pluginspage="http://www.macromedia.com/go/getflashplayer" type="application/x-shockwave-flash" allowscriptaccess="always" quality="high" flashvars="clipboard=%E8%BF%90%E8%A1%8C%E7%BB%93%E6%9E%9C%E5%A6%82%E4%B8%8B%EF%BC%9A%E6%AD%A4%E5%A4%84%E7%9C%81%E7%95%A5%E4%BA%86%E5%8C%85%E5%90%8D%EF%BC%8C***%E4%BB%A3%E6%9B%BF%0Atrue%0Asubject%E7%9A%84Class%E7%B1%BB%E6%98%AF%EF%BC%9Aclass%20%24Proxy0%0Asubject%E4%B8%AD%E7%9A%84%E5%B1%9E%E6%80%A7%E6%9C%89%EF%BC%9Am1%2C%20m3%2C%20m0%2C%20m2%2C%20%0Asubject%E4%B8%AD%E7%9A%84%E6%96%B9%E6%B3%95%E6%9C%89%EF%BC%9Arequest%2C%20hashCode%2C%20equals%2C%20toString%2C%20%0Asubject%E7%9A%84%E7%88%B6%E7%B1%BB%E6%98%AF%EF%BC%9Aclass%20java.lang.reflect.Proxy%0Asubject%E5%AE%9E%E7%8E%B0%E7%9A%84%E6%8E%A5%E5%8F%A3%E6%98%AF%EF%BC%9Acn.edu.ustc.dynamicproxy.Subject%2C%20%0A%0A%E8%BF%90%E8%A1%8C%E7%BB%93%E6%9E%9C%E4%B8%BA%EF%BC%9A%0Abefore%20calling%20public%20abstract%20void%20***.Subject.request()%0AFrom%20real%20subject.%0Aafter%20calling%20public%20abstract%20void%20***.Subject.request()" src="/javascripts/syntaxhighlighter/clipboard_new.swf" wmode="transparent">&nbsp;<a onclick="code_favorites_do_favorite(this);return false;" title="收藏这段代码" href="javascript:void()"><img alt="收藏代码" src="/images/icon_star.png" class="star"><img style="display:none" src="/images/spinner.gif" class="spinner"></a></div></div><ol start="1" class="dp-xml"><li><span><span>运行结果如下：此处省略了包名，***代替&nbsp;&nbsp;</span></span></li><li><span>true&nbsp;&nbsp;</span></li><li><span>subject的Class类是：class&nbsp;$Proxy0&nbsp;&nbsp;</span></li><li><span>subject中的属性有：m1,&nbsp;m3,&nbsp;m0,&nbsp;m2,&nbsp;&nbsp;&nbsp;</span></li><li><span>subject中的方法有：request,&nbsp;hashCode,&nbsp;equals,&nbsp;toString,&nbsp;&nbsp;&nbsp;</span></li><li><span>subject的父类是：class&nbsp;java.lang.reflect.Proxy&nbsp;&nbsp;</span></li><li><span>subject实现的接口是：cn.edu.ustc.dynamicproxy.Subject,&nbsp;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;</span></li><li><span>运行结果为：&nbsp;&nbsp;</span></li><li><span>before&nbsp;calling&nbsp;public&nbsp;abstract&nbsp;void&nbsp;***.Subject.request()&nbsp;&nbsp;</span></li><li><span>From&nbsp;real&nbsp;subject.&nbsp;&nbsp;</span></li><li><span>after&nbsp;calling&nbsp;public&nbsp;abstract&nbsp;void&nbsp;***.Subject.request()&nbsp;&nbsp;</span></li></ol></div><pre name="code" class="xml" style="display: none;" codeable_id="841798" codeable_type="Blog" source_url="http://paddy-w.iteye.com/blog/841798" pre_index="6" title="InvocationHandler中invoke()方法的调用问题">运行结果如下：此处省略了包名，***代替
true
subject的Class类是：class $Proxy0
subject中的属性有：m1, m3, m0, m2, 
subject中的方法有：request, hashCode, equals, toString, 
subject的父类是：class java.lang.reflect.Proxy
subject实现的接口是：cn.edu.ustc.dynamicproxy.Subject, 

运行结果为：
before calling public abstract void ***.Subject.request()
From real subject.
after calling public abstract void ***.Subject.request()</pre>
<br>
<br><span style="color: red;">PS：这个结果的信息非常重要，至少对我来说。因为我在动态代理犯晕的根源就在于将上面的subject.request()理解错了，至少是被表面所迷惑，没有发现这个subject和Proxy之间的联系，一度纠结于最后调用的这个request()是怎么和invoke()联系上的，而invoke又是怎么知道request存在的。其实上面的true和class $Proxy0就能解决很多的疑问，再加上下面将要说的$Proxy0的源码，完全可以解决动态代理的疑惑了。</span>
<br>
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 从以上代码和结果可以看出，我们并没有显示的调用invoke()方法，但是这个方法确实执行了。下面就整个的过程进行分析一下：
<br>
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 从Client中的代码看，可以从newProxyInstance这个方法作为突破口，我们先来看一下Proxy类中newProxyInstance方法的源代码：
<br><div class="dp-highlighter" id=""><div class="bar"><div class="tools">Java代码 <embed width="14" height="15" pluginspage="http://www.macromedia.com/go/getflashplayer" type="application/x-shockwave-flash" allowscriptaccess="always" quality="high" flashvars="clipboard=public%20static%20Object%20newProxyInstance(ClassLoader%20loader%2C%0A%09%09Class%3C%3F%3E%5B%5D%20interfaces%2C%0A%09%09InvocationHandler%20h)%0Athrows%20IllegalArgumentException%0A%7B%0A%09if%20(h%20%3D%3D%20null)%20%7B%0A%09%09throw%20new%20NullPointerException()%3B%0A%09%7D%0A%0A%09%2F*%0A%09%20*%20Look%20up%20or%20generate%20the%20designated%20proxy%20class.%0A%09%20*%2F%0A%09Class%20cl%20%3D%20getProxyClass(loader%2C%20interfaces)%3B%0A%0A%09%2F*%0A%09%20*%20Invoke%20its%20constructor%20with%20the%20designated%20invocation%20handler.%0A%09%20*%2F%0A%09try%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%2F*%0A%09%20%20%20%20%20%20%20%20*%20Proxy%E6%BA%90%E7%A0%81%E5%BC%80%E5%A7%8B%E6%9C%89%E8%BF%99%E6%A0%B7%E7%9A%84%E5%AE%9A%E4%B9%89%EF%BC%9A%0A%20%20%20%20%20%20%20%20%20%20%20%20*%20private%20final%20static%20Class%5B%5D%20constructorParams%20%3D%20%7B%20InvocationHandler.class%20%7D%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20*%20cons%E5%8D%B3%E6%98%AF%E5%BD%A2%E5%8F%82%E4%B8%BAInvocationHandler%E7%B1%BB%E5%9E%8B%E7%9A%84%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95%0A%09%20%20%20%20%20%20%20*%2F%0A%09%09Constructor%20cons%20%3D%20cl.getConstructor(constructorParams)%3B%0A%09%09return%20(Object)%20cons.newInstance(new%20Object%5B%5D%20%7B%20h%20%7D)%3B%0A%09%7D%20catch%20(NoSuchMethodException%20e)%20%7B%0A%09%09throw%20new%20InternalError(e.toString())%3B%0A%09%7D%20catch%20(IllegalAccessException%20e)%20%7B%0A%09%09throw%20new%20InternalError(e.toString())%3B%0A%09%7D%20catch%20(InstantiationException%20e)%20%7B%0A%09%09throw%20new%20InternalError(e.toString())%3B%0A%09%7D%20catch%20(InvocationTargetException%20e)%20%7B%0A%09%09throw%20new%20InternalError(e.toString())%3B%0A%09%7D%0A%7D" src="/javascripts/syntaxhighlighter/clipboard_new.swf" wmode="transparent">&nbsp;<a onclick="code_favorites_do_favorite(this);return false;" title="收藏这段代码" href="javascript:void()"><img alt="收藏代码" src="/images/icon_star.png" class="star"><img style="display:none" src="/images/spinner.gif" class="spinner"></a></div></div><ol start="1" class="dp-j"><li><span><span class="keyword">public</span><span>&nbsp;</span><span class="keyword">static</span><span>&nbsp;Object&nbsp;newProxyInstance(ClassLoader&nbsp;loader,&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Class&lt;?&gt;[]&nbsp;interfaces,&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;InvocationHandler&nbsp;h)&nbsp;&nbsp;</span></li><li><span><span class="keyword">throws</span><span>&nbsp;IllegalArgumentException&nbsp;&nbsp;</span></span></li><li><span>{&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span><span>&nbsp;(h&nbsp;==&nbsp;</span><span class="keyword">null</span><span>)&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">throw</span><span>&nbsp;</span><span class="keyword">new</span><span>&nbsp;NullPointerException();&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">/*</span>&nbsp;</span></li><li><span><span class="comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Look&nbsp;up&nbsp;or&nbsp;generate&nbsp;the&nbsp;designated&nbsp;proxy&nbsp;class.</span>&nbsp;</span></li><li><span><span class="comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;Class&nbsp;cl&nbsp;=&nbsp;getProxyClass(loader,&nbsp;interfaces);&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">/*</span>&nbsp;</span></li><li><span><span class="comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Invoke&nbsp;its&nbsp;constructor&nbsp;with&nbsp;the&nbsp;designated&nbsp;invocation&nbsp;handler.</span>&nbsp;</span></li><li><span><span class="comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span><span>&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">/*</span>&nbsp;</span></li><li><span><span class="comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Proxy源码开始有这样的定义：</span>&nbsp;</span></li><li><span><span class="comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;private&nbsp;final&nbsp;static&nbsp;Class[]&nbsp;constructorParams&nbsp;=&nbsp;{&nbsp;InvocationHandler.class&nbsp;};</span>&nbsp;</span></li><li><span><span class="comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;cons即是形参为InvocationHandler类型的构造方法</span>&nbsp;</span></li><li><span><span class="comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Constructor&nbsp;cons&nbsp;=&nbsp;cl.getConstructor(constructorParams);&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span><span>&nbsp;(Object)&nbsp;cons.newInstance(</span><span class="keyword">new</span><span>&nbsp;Object[]&nbsp;{&nbsp;h&nbsp;});&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span class="keyword">catch</span><span>&nbsp;(NoSuchMethodException&nbsp;e)&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">throw</span><span>&nbsp;</span><span class="keyword">new</span><span>&nbsp;InternalError(e.toString());&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span class="keyword">catch</span><span>&nbsp;(IllegalAccessException&nbsp;e)&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">throw</span><span>&nbsp;</span><span class="keyword">new</span><span>&nbsp;InternalError(e.toString());&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span class="keyword">catch</span><span>&nbsp;(InstantiationException&nbsp;e)&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">throw</span><span>&nbsp;</span><span class="keyword">new</span><span>&nbsp;InternalError(e.toString());&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span class="keyword">catch</span><span>&nbsp;(InvocationTargetException&nbsp;e)&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">throw</span><span>&nbsp;</span><span class="keyword">new</span><span>&nbsp;InternalError(e.toString());&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>}&nbsp;&nbsp;</span></li></ol></div><pre name="code" class="java" style="display: none;" codeable_id="841798" codeable_type="Blog" source_url="http://paddy-w.iteye.com/blog/841798" pre_index="7" title="InvocationHandler中invoke()方法的调用问题">public static Object newProxyInstance(ClassLoader loader,
		Class&lt;?&gt;[] interfaces,
		InvocationHandler h)
throws IllegalArgumentException
{
	if (h == null) {
		throw new NullPointerException();
	}

	/*
	 * Look up or generate the designated proxy class.
	 */
	Class cl = getProxyClass(loader, interfaces);

	/*
	 * Invoke its constructor with the designated invocation handler.
	 */
	try {
           /*
	        * Proxy源码开始有这样的定义：
            * private final static Class[] constructorParams = { InvocationHandler.class };
            * cons即是形参为InvocationHandler类型的构造方法
	       */
		Constructor cons = cl.getConstructor(constructorParams);
		return (Object) cons.newInstance(new Object[] { h });
	} catch (NoSuchMethodException e) {
		throw new InternalError(e.toString());
	} catch (IllegalAccessException e) {
		throw new InternalError(e.toString());
	} catch (InstantiationException e) {
		throw new InternalError(e.toString());
	} catch (InvocationTargetException e) {
		throw new InternalError(e.toString());
	}
}</pre>
<br>
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Proxy.newProxyInstance(ClassLoader loader, Class&lt;?&gt;[] interfaces, InvocationHandler h)做了以下几件事.
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; （1）根据参数loader和interfaces调用方法 getProxyClass(loader, interfaces)创建代理类$Proxy0.$Proxy0类 实现了interfaces的接口,并继承了Proxy类.
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; （2）实例化$Proxy0并在构造方法中把DynamicSubject传过去,接着$Proxy0调用父类Proxy的构造器,为h赋值,如下：
<br><div class="dp-highlighter" id=""><div class="bar"><div class="tools">Java代码 <embed width="14" height="15" pluginspage="http://www.macromedia.com/go/getflashplayer" type="application/x-shockwave-flash" allowscriptaccess="always" quality="high" flashvars="clipboard=class%20Proxy%7B%0A%09InvocationHandler%20h%3Dnull%3B%0A%09protected%20Proxy(InvocationHandler%20h)%20%7B%0A%09%09this.h%20%3D%20h%3B%0A%09%7D%0A%09...%0A%7D" src="/javascripts/syntaxhighlighter/clipboard_new.swf" wmode="transparent">&nbsp;<a onclick="code_favorites_do_favorite(this);return false;" title="收藏这段代码" href="javascript:void()"><img alt="收藏代码" src="/images/icon_star.png" class="star"><img style="display:none" src="/images/spinner.gif" class="spinner"></a></div></div><ol start="1" class="dp-j"><li><span><span class="keyword">class</span><span>&nbsp;Proxy{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;InvocationHandler&nbsp;h=<span class="keyword">null</span><span>;&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">protected</span><span>&nbsp;Proxy(InvocationHandler&nbsp;h)&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">this</span><span>.h&nbsp;=&nbsp;h;&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;&nbsp;</span></li><li><span>}&nbsp;&nbsp;</span></li></ol></div><pre name="code" class="java" style="display: none;" codeable_id="841798" codeable_type="Blog" source_url="http://paddy-w.iteye.com/blog/841798" pre_index="8" title="InvocationHandler中invoke()方法的调用问题">class Proxy{
	InvocationHandler h=null;
	protected Proxy(InvocationHandler h) {
		this.h = h;
	}
	...
}</pre>
<br>
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 来看一下这个继承了Proxy的$Proxy0的源代码：
<br><div class="dp-highlighter" id=""><div class="bar"><div class="tools">Java代码 <embed width="14" height="15" pluginspage="http://www.macromedia.com/go/getflashplayer" type="application/x-shockwave-flash" allowscriptaccess="always" quality="high" flashvars="clipboard=public%20final%20class%20%24Proxy0%20extends%20Proxy%20implements%20Subject%20%7B%0A%09private%20static%20Method%20m1%3B%0A%09private%20static%20Method%20m0%3B%0A%09private%20static%20Method%20m3%3B%0A%09private%20static%20Method%20m2%3B%0A%0A%09static%20%7B%0A%09%09try%20%7B%0A%09%09%09m1%20%3D%20Class.forName(%22java.lang.Object%22).getMethod(%22equals%22%2C%0A%09%09%09%09%09new%20Class%5B%5D%20%7B%20Class.forName(%22java.lang.Object%22)%20%7D)%3B%0A%0A%09%09%09m0%20%3D%20Class.forName(%22java.lang.Object%22).getMethod(%22hashCode%22%2C%0A%09%09%09%09%09new%20Class%5B0%5D)%3B%0A%0A%09%09%09m3%20%3D%20Class.forName(%22***.RealSubject%22).getMethod(%22request%22%2C%0A%09%09%09%09%09new%20Class%5B0%5D)%3B%0A%0A%09%09%09m2%20%3D%20Class.forName(%22java.lang.Object%22).getMethod(%22toString%22%2C%0A%09%09%09%09%09new%20Class%5B0%5D)%3B%0A%0A%09%09%7D%20catch%20(NoSuchMethodException%20nosuchmethodexception)%20%7B%0A%09%09%09throw%20new%20NoSuchMethodError(nosuchmethodexception.getMessage())%3B%0A%09%09%7D%20catch%20(ClassNotFoundException%20classnotfoundexception)%20%7B%0A%09%09%09throw%20new%20NoClassDefFoundError(classnotfoundexception.getMessage())%3B%0A%09%09%7D%0A%09%7D%20%2F%2Fstatic%0A%0A%09public%20%24Proxy0(InvocationHandler%20invocationhandler)%20%7B%0A%09%09super(invocationhandler)%3B%0A%09%7D%0A%0A%09%40Override%0A%09public%20final%20boolean%20equals(Object%20obj)%20%7B%0A%09%09try%20%7B%0A%09%09%09return%20((Boolean)%20super.h.invoke(this%2C%20m1%2C%20new%20Object%5B%5D%20%7B%20obj%20%7D))%20.booleanValue()%3B%0A%09%09%7D%20catch%20(Throwable%20throwable)%20%7B%0A%09%09%09throw%20new%20UndeclaredThrowableException(throwable)%3B%0A%09%09%7D%0A%09%7D%0A%0A%09%40Override%0A%09public%20final%20int%20hashCode()%20%7B%0A%09%09try%20%7B%0A%09%09%09return%20((Integer)%20super.h.invoke(this%2C%20m0%2C%20null)).intValue()%3B%0A%09%09%7D%20catch%20(Throwable%20throwable)%20%7B%0A%09%09%09throw%20new%20UndeclaredThrowableException(throwable)%3B%0A%09%09%7D%0A%09%7D%0A%0A%09public%20final%20void%20request()%20%7B%0A%09%09try%20%7B%0A%09%09%09super.h.invoke(this%2C%20m3%2C%20null)%3B%0A%09%09%09return%3B%0A%09%09%7D%20catch%20(Error%20e)%20%7B%0A%09%09%7D%20catch%20(Throwable%20throwable)%20%7B%0A%09%09%09throw%20new%20UndeclaredThrowableException(throwable)%3B%0A%09%09%7D%0A%09%7D%0A%0A%09%40Override%0A%09public%20final%20String%20toString()%20%7B%0A%09%09try%20%7B%0A%09%09%09return%20(String)%20super.h.invoke(this%2C%20m2%2C%20null)%3B%0A%09%09%7D%20catch%20(Throwable%20throwable)%20%7B%0A%09%09%09throw%20new%20UndeclaredThrowableException(throwable)%3B%0A%09%09%7D%0A%09%7D%0A%7D" src="/javascripts/syntaxhighlighter/clipboard_new.swf" wmode="transparent">&nbsp;<a onclick="code_favorites_do_favorite(this);return false;" title="收藏这段代码" href="javascript:void()"><img alt="收藏代码" src="/images/icon_star.png" class="star"><img style="display:none" src="/images/spinner.gif" class="spinner"></a></div></div><ol start="1" class="dp-j"><li><span><span class="keyword">public</span><span>&nbsp;</span><span class="keyword">final</span><span>&nbsp;</span><span class="keyword">class</span><span>&nbsp;$Proxy0&nbsp;</span><span class="keyword">extends</span><span>&nbsp;Proxy&nbsp;</span><span class="keyword">implements</span><span>&nbsp;Subject&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">private</span><span>&nbsp;</span><span class="keyword">static</span><span>&nbsp;Method&nbsp;m1;&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">private</span><span>&nbsp;</span><span class="keyword">static</span><span>&nbsp;Method&nbsp;m0;&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">private</span><span>&nbsp;</span><span class="keyword">static</span><span>&nbsp;Method&nbsp;m3;&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">private</span><span>&nbsp;</span><span class="keyword">static</span><span>&nbsp;Method&nbsp;m2;&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">static</span><span>&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span><span>&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m1&nbsp;=&nbsp;Class.forName(<span class="string">"java.lang.Object"</span><span>).getMethod(</span><span class="string">"equals"</span><span>,&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">new</span><span>&nbsp;Class[]&nbsp;{&nbsp;Class.forName(</span><span class="string">"java.lang.Object"</span><span>)&nbsp;});&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m0&nbsp;=&nbsp;Class.forName(<span class="string">"java.lang.Object"</span><span>).getMethod(</span><span class="string">"hashCode"</span><span>,&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">new</span><span>&nbsp;Class[</span><span class="number">0</span><span>]);&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m3&nbsp;=&nbsp;Class.forName(<span class="string">"***.RealSubject"</span><span>).getMethod(</span><span class="string">"request"</span><span>,&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">new</span><span>&nbsp;Class[</span><span class="number">0</span><span>]);&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m2&nbsp;=&nbsp;Class.forName(<span class="string">"java.lang.Object"</span><span>).getMethod(</span><span class="string">"toString"</span><span>,&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">new</span><span>&nbsp;Class[</span><span class="number">0</span><span>]);&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span class="keyword">catch</span><span>&nbsp;(NoSuchMethodException&nbsp;nosuchmethodexception)&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">throw</span><span>&nbsp;</span><span class="keyword">new</span><span>&nbsp;NoSuchMethodError(nosuchmethodexception.getMessage());&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span class="keyword">catch</span><span>&nbsp;(ClassNotFoundException&nbsp;classnotfoundexception)&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">throw</span><span>&nbsp;</span><span class="keyword">new</span><span>&nbsp;NoClassDefFoundError(classnotfoundexception.getMessage());&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span class="comment">//static</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">public</span><span>&nbsp;$Proxy0(InvocationHandler&nbsp;invocationhandler)&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">super</span><span>(invocationhandler);&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="annotation">@Override</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">public</span><span>&nbsp;</span><span class="keyword">final</span><span>&nbsp;</span><span class="keyword">boolean</span><span>&nbsp;equals(Object&nbsp;obj)&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span><span>&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span><span>&nbsp;((Boolean)&nbsp;</span><span class="keyword">super</span><span>.h.invoke(</span><span class="keyword">this</span><span>,&nbsp;m1,&nbsp;</span><span class="keyword">new</span><span>&nbsp;Object[]&nbsp;{&nbsp;obj&nbsp;}))&nbsp;.booleanValue();&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span class="keyword">catch</span><span>&nbsp;(Throwable&nbsp;throwable)&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">throw</span><span>&nbsp;</span><span class="keyword">new</span><span>&nbsp;UndeclaredThrowableException(throwable);&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="annotation">@Override</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">public</span><span>&nbsp;</span><span class="keyword">final</span><span>&nbsp;</span><span class="keyword">int</span><span>&nbsp;hashCode()&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span><span>&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span><span>&nbsp;((Integer)&nbsp;</span><span class="keyword">super</span><span>.h.invoke(</span><span class="keyword">this</span><span>,&nbsp;m0,&nbsp;</span><span class="keyword">null</span><span>)).intValue();&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span class="keyword">catch</span><span>&nbsp;(Throwable&nbsp;throwable)&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">throw</span><span>&nbsp;</span><span class="keyword">new</span><span>&nbsp;UndeclaredThrowableException(throwable);&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">public</span><span>&nbsp;</span><span class="keyword">final</span><span>&nbsp;</span><span class="keyword">void</span><span>&nbsp;request()&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span><span>&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">super</span><span>.h.invoke(</span><span class="keyword">this</span><span>,&nbsp;m3,&nbsp;</span><span class="keyword">null</span><span>);&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span><span>;&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span class="keyword">catch</span><span>&nbsp;(Error&nbsp;e)&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span class="keyword">catch</span><span>&nbsp;(Throwable&nbsp;throwable)&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">throw</span><span>&nbsp;</span><span class="keyword">new</span><span>&nbsp;UndeclaredThrowableException(throwable);&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="annotation">@Override</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">public</span><span>&nbsp;</span><span class="keyword">final</span><span>&nbsp;String&nbsp;toString()&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span><span>&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span><span>&nbsp;(String)&nbsp;</span><span class="keyword">super</span><span>.h.invoke(</span><span class="keyword">this</span><span>,&nbsp;m2,&nbsp;</span><span class="keyword">null</span><span>);&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span class="keyword">catch</span><span>&nbsp;(Throwable&nbsp;throwable)&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">throw</span><span>&nbsp;</span><span class="keyword">new</span><span>&nbsp;UndeclaredThrowableException(throwable);&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>}&nbsp;&nbsp;</span></li></ol></div><pre name="code" class="java" style="display: none;" codeable_id="841798" codeable_type="Blog" source_url="http://paddy-w.iteye.com/blog/841798" pre_index="9" title="InvocationHandler中invoke()方法的调用问题">public final class $Proxy0 extends Proxy implements Subject {
	private static Method m1;
	private static Method m0;
	private static Method m3;
	private static Method m2;

	static {
		try {
			m1 = Class.forName("java.lang.Object").getMethod("equals",
					new Class[] { Class.forName("java.lang.Object") });

			m0 = Class.forName("java.lang.Object").getMethod("hashCode",
					new Class[0]);

			m3 = Class.forName("***.RealSubject").getMethod("request",
					new Class[0]);

			m2 = Class.forName("java.lang.Object").getMethod("toString",
					new Class[0]);

		} catch (NoSuchMethodException nosuchmethodexception) {
			throw new NoSuchMethodError(nosuchmethodexception.getMessage());
		} catch (ClassNotFoundException classnotfoundexception) {
			throw new NoClassDefFoundError(classnotfoundexception.getMessage());
		}
	} //static

	public $Proxy0(InvocationHandler invocationhandler) {
		super(invocationhandler);
	}

	@Override
	public final boolean equals(Object obj) {
		try {
			return ((Boolean) super.h.invoke(this, m1, new Object[] { obj })) .booleanValue();
		} catch (Throwable throwable) {
			throw new UndeclaredThrowableException(throwable);
		}
	}

	@Override
	public final int hashCode() {
		try {
			return ((Integer) super.h.invoke(this, m0, null)).intValue();
		} catch (Throwable throwable) {
			throw new UndeclaredThrowableException(throwable);
		}
	}

	public final void request() {
		try {
			super.h.invoke(this, m3, null);
			return;
		} catch (Error e) {
		} catch (Throwable throwable) {
			throw new UndeclaredThrowableException(throwable);
		}
	}

	@Override
	public final String toString() {
		try {
			return (String) super.h.invoke(this, m2, null);
		} catch (Throwable throwable) {
			throw new UndeclaredThrowableException(throwable);
		}
	}
}</pre>
<br>
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 接着把得到的$Proxy0实例强制转换成Subject，并将引用赋给subject。当执行subject.request()方法时，就调用了$Proxy0类中的request()方法，进而调用父类Proxy中的h的invoke()方法.即InvocationHandler.invoke()。
<br>
<br><span style="color: red;">PS：1、需要说明的一点是，Proxy类中getProxyClass方法返回的是Proxy的Class类。之所以说明，是因为我一开始犯了个低级错误，以为返回的是“被代理类的Class类”- -！推荐看一下getProxyClass的源码，很长=。=
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2、从$Proxy0的源码可以看出，动态代理类不仅代理了显示定义的接口中的方法，而且还代理了java的根类Object中的继承而来的equals()、hashcode()、toString()这三个方法，并且仅此三个方法。</span>
<br>
  </div>
</div>
